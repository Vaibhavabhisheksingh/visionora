<% layout("/layouts/boilerplate") %>

<div class="container mt-5">

    <!-- Back Button -->
    <a href="/listings/allProducts" class="btn btn-outline-dark mb-4 rounded-pill">
        ← Back to Collection
    </a>

    <div class="row g-5">

        <!-- LEFT: Product Image -->
        <div class="col-md-6">
            <img 
                src="<%= listing.image.url %>"
                alt="<%= listing.title %>" 
                class="img-fluid rounded shadow-sm"
                style="width:100%; max-height:450px; object-fit:cover;"
            >
        </div>

        <!-- RIGHT: Product Info -->
        <div class="col-md-6 d-flex flex-column">

            <h1 class="fw-bold mb-3"><%= listing.title %></h1>

            <h4 class="text-primary fw-semibold mb-4">
                ₹<%= listing.price.toLocaleString("en-IN")%>
            </h4>

            <p class="text-muted mb-4" style="font-size: 1.05rem;">
                <%= listing.description %>
            </p>

            <!-- Buy Button -->
            <a href="/orders/<%= listing._id %>/address" class="btn btn-success btn-lg rounded-pill mb-3">
    Buy Now
</a>


           <form action="/cart/add/<%= listing._id %>" method="POST">
    <button class="btn btn-dark w-100 mt-3 rounded-pill mb-3">
        Add to Cart
    </button>
</form>
            <% if (currentUser && currentUser.username === "admin") { %>

    <!-- Edit Button -->
    <a href="/listings/<%= listing._id %>/edit" 
       class="btn btn-warning btn-sm rounded-pill mb-3">
       <i class="fa-solid fa-pen"></i> Edit
    </a>

    <!-- Delete Button -->
    <form action="/listings/<%= listing._id %>?_method=DELETE" 
          method="POST" class="d-inline">
        <button class="btn btn-danger btn-sm rounded-pill mb-3">
            <i class="fa-solid fa-trash"></i> Delete
        </button>
    </form>

<% } %>
        </div>

    </div>
    <% if(currentUser){ %>
<!-- Review Form Section -->
<div class="container mt-5 mb-5">
    <div class="card shadow-sm border-0 rounded-4 p-4">
        <h4 class="mb-3">Leave a Review</h4>

        <!-- Bootstrap Validated Review Form -->
        <form 
            action="/listings/<%= listing._id %>/reviews"  
            method="POST" 
            class="needs-validation" 
            novalidate
        >
                <div class="mb-3">
                    <fieldset class="starability-slot">
                        <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
                        <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                        <label for="first-rate1" title="Terrible">1 star</label>
                        <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                        <label for="first-rate2" title="Not good">2 stars</label>
                        <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                        <label for="first-rate3" title="Average">3 stars</label>
                        <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                        <label for="first-rate4" title="Very good">4 stars</label>
                        <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                        <label for="first-rate5" title="Amazing">5 stars</label>
                    </fieldset>
            </div>

            <!-- Comment -->
            <div class="mb-3">
                <label class="form-label">Comment</label>
                <textarea 
                    name="review[comment]" 
                    rows="3" 
                    class="form-control" 
                    placeholder="Write your experience..." 
                    required
                ></textarea>
                <div class="invalid-feedback">
                    Comment cannot be empty.
                </div>
            </div>

            <button class="btn btn-primary rounded-pill fw-semibold px-4" type="submit">
                Submit Review
            </button>
        </form>
    </div>
    <% } %>
    <!-- Reviews Section -->
<div class="container mt-5 mb-5">
    <h3 class="mb-4 fw-bold">Customer Reviews</h3>

    <% if (listing.reviews.length === 0) { %>
        <p class="text-muted">No reviews yet. Be the first to review this product!</p>
    <% } %>

    <div class="row gy-4">

        <% listing.reviews.forEach(review => { %>
            <div class="col-md-6">
                <div class="card shadow-sm border-0 rounded-4 p-3">

                    <p class="fw-bold mb-1">
                        <i class="fa-solid fa-user"></i>
                        <%= review.author.username %>
                    </p>

                    <!-- Rating Stars -->
                    <div class="mb-2">
                        <p class="starability-result card-text" data-rating="<%= review.rating %>">
                        </p>
                    </div>

                    <!-- Comment -->
                    <p class="mb-2"><%= review.comment %></p>

                    <!-- Date -->
                    <p class="text-muted small">
                        Posted on 
                        <%= review.createdAt ? new Date(review.createdAt).toLocaleDateString() : "Unknown Date" %>

                    </p>

                    <!-- Delete Review -->
                    <form 
                        action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" 
                        method="POST"
                    >
                        <button class="btn btn-sm btn-outline-danger rounded-pill">
                            <i class="fa-solid fa-trash"></i> Delete
                        </button>
                    </form>

                </div>
            </div>
        <% }) %>

    </div>
</div>

</div>